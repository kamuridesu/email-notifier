name: CI
on: [push, pull_request]
jobs:
  deploy:
    name: "Deploy to aws"
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && 'refs/head/master'
    steps:
      - name: "Configure SSH key"
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/aws
          chmod 600 ~/.ssh/aws
          cat >>~/.ssh/config <<END
          Host kamuridesu.tech
            HostName kamuridesu.tech
            User admin
            IdentityFile ~/.ssh/aws
            StrictHostKeyChecking no
          END
        env:
            SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
        
      - name: "Update repository"
        run: ssh admin@kamuridesu.tech "rm -rf email-notifier; git clone https://github.com/kamuridesu/email-notifier.git"
      - name: "Add token"
        run: ssh admin@kamuridesu.tech 'echo "${{ secrets.TOKEN }}" > /home/admin/email-notifier/tokens.json'
      - name: "Parse token"
        run: |
          ssh admin@kamuridesu.tech "sleep 3;cd email-notifier;python -c \"globals().update({'add_var': lambda x, y: globals().update({x: y})}); add_var('content', '$(cat tokens.json)'); add_var('split_content', content.split(',')); add_var('split_content', [x.strip() for x in split_content]); add_var('content', [{x.split(':')[0].replace('{', '').strip(): ':'.join(x.split(':')[1:]).replace('}', '').strip()} for x in split_content]); add_var('new_content', {});[new_content.update(x) for x in content]; print(__import__('json').dumps(new_content))\" > tokens.json"
      - name: "Build image"
        run: ssh admin@kamuridesu.tech "cd email-notifier; sudo docker build -t email-notifier ."
      - name: "Deploy new version"
        run: ssh admin@kamuridesu.tech "sudo docker rm -f email-notifier; sudo docker run --name email-notifier -d email-notifier"
